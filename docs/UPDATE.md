# دليل تحديث موقع مشكاة

## طريقة تحديث الموقع

### 1. التعديل المحلي
1. قم بتعديل الملفات على جهازك المحلي
2. اختبر التغييرات محلياً للتأكد من عملها
3. احفظ التغييرات في Git:
```bash
git add .
git commit -m "وصف التغييرات"
```

### 2. رفع التحديثات للخادم
```bash
# الاتصال بالخادم
ssh mshkat@<DROPLET_IP>

# الدخول لمجلد التطبيق
cd ~/app

# سحب التحديثات الجديدة
git pull

# تثبيت أي اعتماديات جديدة
npm install

# إعادة بناء تطبيق الواجهة الأمامية
cd islamic-gifts-shop
npm install
npm run build

# العودة للمجلد الرئيسي
cd ..

# إعادة تشغيل التطبيق
pm2 reload all
```

### 3. التحقق من التحديثات
1. تصفح الموقع وتأكد من ظهور التغييرات
2. تحقق من سجلات الخطأ:
```bash
pm2 logs
```

### 4. التراجع عن التحديثات (في حالة وجود مشاكل)
```bash
# العودة للإصدار السابق
git reset --hard HEAD^

# إعادة تشغيل التطبيق
pm2 reload all
```

## مراقبة الموقع

### عرض حالة الخادم
```bash
# عرض حالة التطبيق
pm2 status

# عرض استخدام الموارد
pm2 monit
```

### عرض السجلات
```bash
# عرض جميع السجلات
pm2 logs

# عرض سجلات خطأ محددة
pm2 logs --error

# عرض سجلات تطبيق محدد
pm2 logs mshkat-backend
```

## إجراءات الصيانة

### 1. تنظيف السجلات
```bash
# تنظيف سجلات PM2
pm2 flush

# تنظيف سجلات النظام القديمة
sudo journalctl --vacuum-time=7d
```

### 2. تحديث النظام
```bash
# تحديث حزم النظام
sudo apt update
sudo apt upgrade -y

# تحديث Node.js (إذا لزم الأمر)
sudo n stable
```

### 3. النسخ الاحتياطي
- يتم عمل نسخة احتياطية تلقائية يومياً
- يمكنك عمل نسخة احتياطية يدوياً:
```bash
/usr/local/bin/backup.sh
```

## حل المشاكل الشائعة

### 1. الموقع لا يعمل
```bash
# تحقق من حالة التطبيق
pm2 status

# إعادة تشغيل التطبيق
pm2 reload all

# تحقق من سجلات الخطأ
pm2 logs --error
```

### 2. مشاكل في رفع الصور
```bash
# تحقق من صلاحيات مجلد الصور
sudo chown -R mshkat:mshkat ~/app/uploads
sudo chmod -R 755 ~/app/uploads
```

### 3. مشاكل في قاعدة البيانات
```bash
# تحقق من ملفات البيانات
ls -l ~/app/backend/data/

# إصلاح صلاحيات الملفات
sudo chown -R mshkat:mshkat ~/app/backend/data
sudo chmod -R 644 ~/app/backend/data/*.json
```

## ملاحظات هامة
1. احرص دائماً على اختبار التغييرات محلياً قبل رفعها للخادم
2. احتفظ بنسخة احتياطية قبل إجراء تغييرات كبيرة
3. راقب سجلات الخطأ بعد كل تحديث
4. تأكد من تحديث الإعدادات في ملف `config.js` إذا لزم الأمر
