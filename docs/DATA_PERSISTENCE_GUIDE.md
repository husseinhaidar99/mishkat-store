# دليل استمرارية البيانات - Data Persistence Guide

## نظرة عامة
تم تحسين نظام حفظ البيانات في متجر مشكاة لضمان عدم فقدان أي تغييرات عند إعادة تشغيل الخادم أو الموقع.

## الميزات الجديدة

### ✅ حفظ تلقائي محسن
- **حفظ فوري**: كل عملية إضافة أو تعديل أو حذف تُحفظ فوراً في الملفات
- **تأكيد العمليات**: رسائل تأكيد في السجل لكل عملية حفظ ناجحة
- **معالجة الأخطاء**: نظام شامل لمعالجة أخطاء الحفظ

### 💾 نسخ احتياطية تلقائية
- **نسخ دورية**: كل 30 دقيقة يتم إنشاء نسخة احتياطية تلقائياً
- **الحفظ الذكي**: الاحتفاظ بآخر 5 نسخ احتياطية فقط
- **نسخة عند البدء**: نسخة احتياطية تُنشأ عند بدء تشغيل الخادم

### 📊 مراقبة البيانات
- **إحصائيات البدء**: عرض عدد المنتجات والفئات والإعدادات عند التشغيل
- **سجل العمليات**: تسجيل مفصل لجميع عمليات الحفظ والتحميل
- **تحديثات فورية**: عرض التغييرات في السجل فور حدوثها

## مسارات الملفات

### البيانات الأساسية
```
backend/data/
├── products.json      # المنتجات
├── categories.json    # الفئات  
├── settings.json      # الإعدادات
└── backups/          # النسخ الاحتياطية
    ├── backup-2025-05-26T00-05-06-111Z.json
    ├── backup-2025-05-26T00-05-11-730Z.json
    └── ...
```

### الصور والملفات
```
backend/uploads/
└── products/         # صور المنتجات
    ├── 1747748376017-858664102.jpg
    └── ...
```

## كيفية التحقق من حفظ البيانات

### 1. مراقبة السجل
عند تشغيل الخادم، ستظهر رسائل مثل:
```
✅ Data loaded successfully from [PATH]
🚀 Server is running on port 3001
📊 Loaded data:
   - Products: X items
   - Categories: Y items  
   - Settings: Z sections
```

### 2. تأكيد العمليات
عند إضافة منتج أو فئة جديدة، ستظهر رسائل مثل:
```
✅ Product added: [اسم المنتج] (ID: [الرقم])
✅ Category added: [اسم الفئة]
✅ Settings updated successfully
```

### 3. فحص الملفات
يمكنك فحص ملفات البيانات مباشرة:
- `backend/data/products.json`
- `backend/data/categories.json`  
- `backend/data/settings.json`

## استعادة البيانات (للطوارئ)

### API للاستعادة
```http
POST /api/restore
Authorization: Bearer [token]
Content-Type: application/json

{
  "backupFile": "backup-2025-05-26T00-05-06-111Z.json"
}
```

### الحصول على قائمة النسخ الاحتياطية
```http
GET /api/backups
Authorization: Bearer [token]
```

## نصائح مهمة

### ✅ الممارسات الصحيحة
- تأكد من وجود مساحة كافية على القرص الصلب
- راقب سجل الخادم بانتظام للتأكد من عدم وجود أخطاء
- احتفظ بنسخ احتياطية خارجية دورية

### ⚠️ تجنب هذه الأخطاء
- عدم إيقاف الخادم بقوة (استخدم Ctrl+C)
- عدم تعديل ملفات البيانات يدوياً أثناء تشغيل الخادم
- عدم حذف مجلد `data` أو `uploads` بدون نسخ احتياطية

## استكشاف الأخطاء

### المشكلة: البيانات لا تُحفظ
1. تحقق من سجل الخادم للأخطاء
2. تأكد من أذونات الكتابة في مجلد `data`
3. تحقق من وجود مساحة كافية على القرص

### المشكلة: فقدان البيانات
1. تحقق من مجلد `data/backups`
2. استخدم API الاستعادة لاستعادة آخر نسخة احتياطية
3. تحقق من ملف `error.log` للأخطاء

### المشكلة: الخادم لا يبدأ
1. تحقق من ملف `error.log`
2. تأكد من عدم تشغيل خادم آخر على نفس المنفذ
3. أعد تشغيل الخادم باستخدام `npm run dev`

## الدعم الفني
إذا واجهت أي مشاكل مع حفظ البيانات، تحقق من:
1. سجل الخادم (Terminal output)
2. ملف الأخطاء `backend/error.log`
3. أذونات ملفات النظام
4. مساحة القرص الصلب المتاحة
